varnishtest "test vmod-pat"

varnish v1 -vcl+backend {
		backend be none;

        import pat;

		sub vcl_init {
			new ppat = pat.pat(
				issuer = "demo-pat.issuer.cloudflare.com", 
				public_key = "MIIBUjA9BgkqhkiG9w0BAQowMKANMAsGCWCGSAFlAwQCAqEaMBgGCSqGSIb3DQEBCDALBglghkgBZQMEAgKiAwIBMAOCAQ8AMIIBCgKCAQEAysdWcET7XEBJbjsM-QPnk89xWDkmQy-hPRdvbbXiwMtWc8D2WJPfaE0diWcjbKjpJCJww_gzDIZgtTKjCs8Grya4sTCHCdGbC-_pDB4I5thB50fGQif5jLQ5wHY9J6ZGITmfcBGpZa1jT56jwcJOStgIWsvM5_vPt82NkzvsxAqQlu0x6XJ2X4htfslcRceLekxhYk-4qIzapMeU9fOvKX8002AZPYnF9H1aJhvwSGfO_vmpw0MIXB5ULOlsGnYSFgxnRcukfetBtUP7BOG6-IhOCowsfN_ExGQ6KQV89gf4nvr4WXWF6de20vnY13cFdw-iN3FVIQcqjEuvLgkqJwIDAQAB"
			);
		}

        sub vcl_deliver {
			set resp.status = 401;
			set resp.http.ok = ppat.validate_header(req.http.Authorization, "devsn.se", "meo");
	    	set resp.http.www-authenticate = ppat.generate_token_header("devsn.se", "meo");
        }
} -start

client c1 {
	txreq -hdr "Authorization: PrivateToken token=AAKtE5kSZpr5cGdyflhtMtCisFHXwYiHTaAXzVGHJxCC0K2yza8GTyCvQ4eoGFdXBdtNw9MYkI6D855ijw8U5EKLxI0EFHl_zA4Gm1zP0TGzwXgP8TzlUGO1-QPjT18_VVU4x1gfoikiiq3Kz1X_RkJ1mM8LmvuZoLh9SnAZhny4aPCW0Efj9P1NYB18p-Nc_GX70st3taKXWKzVt9_-zCz5Gu7qkhk5tzyJ4TPt4KhT47Jpt-qcO83pVDoCLBHdFqRm5rBIcTE9R97MAuTmI8MrBqgWvhdIxmXArqee1EpltOjIJRgGsqxmEJDHNTTk84XfyU0B_NPrjAVCA02ECtCwZ671WWoCvlDqCS6IU0285_gQMVJrExsw3RZFJJNbz8WoNTkVA8HsocI7IwB7V8Dc_UKh4k6LVjMY25FqcQ9ySlYmRf7CtBaw14jDejninFkDRzdU0KzVVfDwn0fZV6IX"
	rxresp
	expect resp.status == 401
	expect resp.http.www-authenticate == "PrivateToken challenge=AAIAHmRlbW8tcGF0Lmlzc3Vlci5jbG91ZGZsYXJlLmNvbSDjKTm1GjKTAo_R0AbCkphsESurll-gXB8ezUR3jR0xDgAIZGV2c24uc2U=, token-key=MIIBUjA9BgkqhkiG9w0BAQowMKANMAsGCWCGSAFlAwQCAqEaMBgGCSqGSIb3DQEBCDALBglghkgBZQMEAgKiAwIBMAOCAQ8AMIIBCgKCAQEAysdWcET7XEBJbjsM-QPnk89xWDkmQy-hPRdvbbXiwMtWc8D2WJPfaE0diWcjbKjpJCJww_gzDIZgtTKjCs8Grya4sTCHCdGbC-_pDB4I5thB50fGQif5jLQ5wHY9J6ZGITmfcBGpZa1jT56jwcJOStgIWsvM5_vPt82NkzvsxAqQlu0x6XJ2X4htfslcRceLekxhYk-4qIzapMeU9fOvKX8002AZPYnF9H1aJhvwSGfO_vmpw0MIXB5ULOlsGnYSFgxnRcukfetBtUP7BOG6-IhOCowsfN_ExGQ6KQV89gf4nvr4WXWF6de20vnY13cFdw-iN3FVIQcqjEuvLgkqJwIDAQAB, max_age=1"
	expect resp.http.ok == true
} -run

client c2 {
	txreq -hdr "Authorization: PrivateToken token=ABKtE5kSZpr5cGdyflhtMtCisFHXwYiHTaAXzVGHJxCC0K2yza8GTyCvQ4eoGFdXBdtNw9MYkI6D855ijw8U5EKLxI0EFHl_zA4Gm1zP0TGzwXgP8TzlUGO1-QPjT18_VVU4x1gfoikiiq3Kz1X_RkJ1mM8LmvuZoLh9SnAZhny4aPCW0Efj9P1NYB18p-Nc_GX70st3taKXWKzVt9_-zCz5Gu7qkhk5tzyJ4TPt4KhT47Jpt-qcO83pVDoCLBHdFqRm5rBIcTE9R97MAuTmI8MrBqgWvhdIxmXArqee1EpltOjIJRgGsqxmEJDHNTTk84XfyU0B_NPrjAVCA02ECtCwZ671WWoCvlDqCS6IU0285_gQMVJrExsw3RZFJJNbz8WoNTkVA8HsocI7IwB7V8Dc_UKh4k6LVjMY25FqcQ9ySlYmRf7CtBaw14jDejninFkDRzdU0KzVVfDwn0fZV6IX"
	rxresp
	expect resp.status == 401
	expect resp.http.www-authenticate == "PrivateToken challenge=AAIAHmRlbW8tcGF0Lmlzc3Vlci5jbG91ZGZsYXJlLmNvbSDjKTm1GjKTAo_R0AbCkphsESurll-gXB8ezUR3jR0xDgAIZGV2c24uc2U=, token-key=MIIBUjA9BgkqhkiG9w0BAQowMKANMAsGCWCGSAFlAwQCAqEaMBgGCSqGSIb3DQEBCDALBglghkgBZQMEAgKiAwIBMAOCAQ8AMIIBCgKCAQEAysdWcET7XEBJbjsM-QPnk89xWDkmQy-hPRdvbbXiwMtWc8D2WJPfaE0diWcjbKjpJCJww_gzDIZgtTKjCs8Grya4sTCHCdGbC-_pDB4I5thB50fGQif5jLQ5wHY9J6ZGITmfcBGpZa1jT56jwcJOStgIWsvM5_vPt82NkzvsxAqQlu0x6XJ2X4htfslcRceLekxhYk-4qIzapMeU9fOvKX8002AZPYnF9H1aJhvwSGfO_vmpw0MIXB5ULOlsGnYSFgxnRcukfetBtUP7BOG6-IhOCowsfN_ExGQ6KQV89gf4nvr4WXWF6de20vnY13cFdw-iN3FVIQcqjEuvLgkqJwIDAQAB, max_age=1"
	expect resp.http.ok == false
} -run

client c3 {
	txreq -hdr "Authorization: PrivateToken token=Arqee1EpltOjIJRgGsqxmEJDHNTTk84XfyU0B_NPrjAVCA02ECtCwZ671WWoCvlDqRzdU0KzVVfDwn0fZV6IX"
	rxresp
	expect resp.status == 401
	expect resp.http.www-authenticate == "PrivateToken challenge=AAIAHmRlbW8tcGF0Lmlzc3Vlci5jbG91ZGZsYXJlLmNvbSDjKTm1GjKTAo_R0AbCkphsESurll-gXB8ezUR3jR0xDgAIZGV2c24uc2U=, token-key=MIIBUjA9BgkqhkiG9w0BAQowMKANMAsGCWCGSAFlAwQCAqEaMBgGCSqGSIb3DQEBCDALBglghkgBZQMEAgKiAwIBMAOCAQ8AMIIBCgKCAQEAysdWcET7XEBJbjsM-QPnk89xWDkmQy-hPRdvbbXiwMtWc8D2WJPfaE0diWcjbKjpJCJww_gzDIZgtTKjCs8Grya4sTCHCdGbC-_pDB4I5thB50fGQif5jLQ5wHY9J6ZGITmfcBGpZa1jT56jwcJOStgIWsvM5_vPt82NkzvsxAqQlu0x6XJ2X4htfslcRceLekxhYk-4qIzapMeU9fOvKX8002AZPYnF9H1aJhvwSGfO_vmpw0MIXB5ULOlsGnYSFgxnRcukfetBtUP7BOG6-IhOCowsfN_ExGQ6KQV89gf4nvr4WXWF6de20vnY13cFdw-iN3FVIQcqjEuvLgkqJwIDAQAB, max_age=1"
	expect resp.http.ok == false
} -run

client c4 {
	txreq -hdr "Authorization: PrivateToken token="
	rxresp
	expect resp.status == 401
	expect resp.http.www-authenticate == "PrivateToken challenge=AAIAHmRlbW8tcGF0Lmlzc3Vlci5jbG91ZGZsYXJlLmNvbSDjKTm1GjKTAo_R0AbCkphsESurll-gXB8ezUR3jR0xDgAIZGV2c24uc2U=, token-key=MIIBUjA9BgkqhkiG9w0BAQowMKANMAsGCWCGSAFlAwQCAqEaMBgGCSqGSIb3DQEBCDALBglghkgBZQMEAgKiAwIBMAOCAQ8AMIIBCgKCAQEAysdWcET7XEBJbjsM-QPnk89xWDkmQy-hPRdvbbXiwMtWc8D2WJPfaE0diWcjbKjpJCJww_gzDIZgtTKjCs8Grya4sTCHCdGbC-_pDB4I5thB50fGQif5jLQ5wHY9J6ZGITmfcBGpZa1jT56jwcJOStgIWsvM5_vPt82NkzvsxAqQlu0x6XJ2X4htfslcRceLekxhYk-4qIzapMeU9fOvKX8002AZPYnF9H1aJhvwSGfO_vmpw0MIXB5ULOlsGnYSFgxnRcukfetBtUP7BOG6-IhOCowsfN_ExGQ6KQV89gf4nvr4WXWF6de20vnY13cFdw-iN3FVIQcqjEuvLgkqJwIDAQAB, max_age=1"
	expect resp.http.ok == false
} -run

